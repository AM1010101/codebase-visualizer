<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Git Visualizer</title>
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
    <div id="sidebar">
        <div class="header-container">
            <h2 class="header-title">Live Git Mapper</h2>
            <button onclick="fetchData()" class="refresh-btn" title="Refresh Data">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
            </button>
        </div>

        <details open>
            <summary>Time Travel</summary>
            <div class="accordion-content">
                <div class="view-mode-group">
                    <button id="viewModeSingle" class="view-mode-btn active"
                        onclick="setViewMode('single')">Single</button>
                    <button id="viewModeDiff" class="view-mode-btn" onclick="setViewMode('diff')">Manual
                        Diff</button>
                    <button id="viewModeRange" class="view-mode-btn" onclick="setViewMode('range')">Date
                        Range</button>
                </div>

                <div id="committerFilterGroup">
                    <label class="form-label">Filter by Author:</label>
                    <select id="committerSelect" class="select-input" onchange="filterCommitsByAuthor()">
                        <option value="all">All Authors</option>
                    </select>
                </div>

                <div id="targetCommitGroup">
                    <label class="form-label">Target Commit:</label>
                    <select id="commitSelect" class="select-input" onchange="changeCommit()"></select>
                </div>

                <div id="baseCommitGroup" class="hidden">
                    <label class="form-label">Compare Against (Base):</label>
                    <select id="baseCommitSelect" class="select-input" onchange="changeCommit()">
                        <option value="none">--- Select Base ---</option>
                    </select>
                </div>

                <div id="rangeInputs" class="range-input-container">
                    <div class="range-input-group">
                        <div class="range-input-row">
                            <span class="range-input-label">From:</span>
                            <input type="date" id="startDate" class="date-input" onchange="changeCommit()">
                        </div>
                        <div class="range-input-row">
                            <span class="range-input-label">To:</span>
                            <input type="date" id="endDate" class="date-input" onchange="changeCommit()">
                        </div>
                    </div>
                </div>

                <div id="commitInfo" class="commit-info">
                    <div id="commitMessage">Viewing live local changes</div>
                    <div id="fileCount" class="file-count" style="margin-top: 8px; font-size: 12px; opacity: 0.8;">
                        <!-- File count will be populated by JS -->
                    </div>
                </div>
            </div>
        </details>

        <details>
            <summary>Visual Styles</summary>
            <div class="accordion-content">
                <div class="control-group" style="border:none; padding:0; margin-bottom: 16px;">
                    <label>Block Sizing</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="mode" value="size"
                                onchange="render()">File
                            Size</label>
                        <label class="radio-option"><input type="radio" name="mode" value="count" checked
                                onchange="render()">Uniform</label>
                    </div>
                </div>
                <div class="control-group" style="border:none; padding:0; margin-bottom: 16px;">
                    <label>Sort Order</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="sort" value="size" onchange="render()">By
                            Size/Weight</label>
                        <label class="radio-option"><input type="radio" name="sort" value="alpha" checked
                                onchange="render()">Alphabetic</label>
                    </div>
                </div>
                <div class="control-group" style="border:none; padding:0;">
                    <label>Color By</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="colorMode" value="git" checked
                                onchange="toggleColorMode()">Git Status</label>
                        <label class="radio-option"><input type="radio" name="colorMode" value="age"
                                onchange="toggleColorMode()">Recency (Blue→Orange)</label>
                        <label class="radio-option"><input type="radio" name="colorMode" value="activity"
                                onchange="toggleColorMode()">Activity (Change Count)</label>
                    </div>
                    <div id="ageThresholdContainer" class="age-threshold-container">
                        <label class="age-threshold-label">
                            <span>Age Threshold: <span id="ageThresholdValue">14</span> days</span>
                        </label>
                        <input type="range" id="ageThreshold" min="1" max="60" value="14"
                            oninput="updateAgeThreshold(this.value)">
                    </div>
                    <div id="activityThresholdContainer" class="age-threshold-container">
                        <label class="age-threshold-label">
                            <span>Activity Window: <span id="activityThresholdValue">30</span> days</span>
                        </label>
                        <input type="range" id="activityThreshold" min="7" max="90" value="30"
                            oninput="updateActivityThreshold(this.value)">
                    </div>
                </div>
            </div>
        </details>

        <details>
            <summary>Filters</summary>
            <div class="accordion-content">
                <label class="checkbox-label">
                    <input type="checkbox" id="foldersFirst" checked onchange="render()">Folders
                    First
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="filterClean" onchange="render()">Hide Clean
                    Files
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="showUnstaged" checked onchange="render()">Show
                    Unstaged
                </label>
                <label class="checkbox-label" style="margin-bottom: 0;">
                    <input type="checkbox" id="collapseClean" onchange="render()">Collapse
                    Clean Folders
                </label>
            </div>
        </details>

        <details>
            <summary>Ignore List</summary>
            <div class="accordion-content">
                <div style="margin-bottom: 12px;">
                    <label class="form-label" style="margin-bottom: 6px; display: block;">Add folder/file to
                        ignore:</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="ignoreInput" class="select-input" placeholder="e.g., node_modules"
                            style="flex: 1;" onkeypress="if(event.key==='Enter') addToIgnoreList()">
                        <button onclick="addToIgnoreList()" class="refresh-btn" title="Add to ignore list"
                            style="padding: 8px 16px; border-radius: 8px;">Add</button>
                    </div>
                </div>
                <div id="ignoreList" class="collapsed-list" style="max-height: 200px; overflow-y: auto;">
                    Loading...
                </div>
                <button class="secondary w-full" onclick="resetIgnoreList()"
                    style="padding: 8px; font-size: 12px; border-radius: 8px; cursor: pointer; margin-top: 8px;">Reset
                    to Defaults</button>
            </div>
        </details>

        <details>
            <summary>Collapsed Folders</summary>
            <div class="accordion-content">
                <div id="collapsedList" class="collapsed-list">
                    None</div>
                <button class="secondary w-full" onclick="clearCollapsed()"
                    style="padding: 8px; font-size: 12px; border-radius: 8px; cursor: pointer;">Clear
                    All</button>
            </div>
        </details>

        <details>
            <summary>Legend</summary>
            <div class="accordion-content">
                <div class="legend-item">
                    <div class="dot" style="background:#e2e8f0"></div>Clean
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#cbd5e1"></div>Folder (w/ Changes)
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#f59e0b"></div>Modified
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#10b981"></div>Created
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#ef4444"></div>Deleted
                </div>
                <div class="legend-item">
                    <div class="dot" style="background:#6366f1"></div>Untracked
                </div>
            </div>
        </details>
    </div>
    <div id="canvas">
        <div id="tooltip"></div>
        <div id="timeline-controls">
            <button class="nav-btn" id="btnPrev" onclick="navigateCommit(1)"
                title="Previous Commit (Left Arrow)">←</button>
            <div class="timeline-label-container">
                <span id="timeline-label" class="timeline-label">Latest</span>
                <span id="timeline-sublabel" class="timeline-sublabel">vs. Previous</span>
            </div>
            <button class="nav-btn" id="btnNext" onclick="navigateCommit(-1)"
                title="Next Commit (Right Arrow)">→</button>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>

</html>